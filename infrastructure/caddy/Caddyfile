# =============================================================================
# Caddy Reverse Proxy Configuration for HT Base
# =============================================================================
# Features:
#   - Automatic HTTPS with Let's Encrypt
#   - HTTP/2 and HTTP/3 support
#   - Request logging
#   - Health check endpoint bypass
# =============================================================================

{
    # Global options
    email {$ACME_EMAIL:admin@example.com}

    # Use staging for testing (uncomment for production)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main domain configuration
{$DOMAIN:localhost} {
    # Enable compression
    encode gzip zstd

    # Logging
    log {
        output stdout
        format json
        level INFO
    }

    # Health check endpoint (no logging)
    handle /health {
        respond "OK" 200
    }

    # API routes
    handle /api/* {
        reverse_proxy api-gateway:8080 {
            # Health checks
            health_uri /health
            health_interval 30s
            health_timeout 5s

            # Load balancing (if multiple instances)
            lb_policy round_robin

            # Headers
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            # Timeouts for long-running archive operations
            transport http {
                dial_timeout 10s
                response_header_timeout 300s
                read_timeout 300s
                write_timeout 300s
            }
        }
    }

    # Flower monitoring UI (optional)
    handle /flower/* {
        uri strip_prefix /flower
        reverse_proxy flower:5555
    }

    # Default handler
    handle {
        reverse_proxy api-gateway:8080
    }
}

# Monitoring subdomain (optional)
monitor.{$DOMAIN:localhost} {
    # Basic auth for monitoring endpoints
    basicauth {
        admin {$MONITOR_PASSWORD_HASH:$2a$14$...}
    }

    # Flower
    handle /flower/* {
        uri strip_prefix /flower
        reverse_proxy flower:5555
    }

    # Redis Commander
    handle /redis/* {
        uri strip_prefix /redis
        reverse_proxy redis-commander:8081
    }

    respond "Monitoring Dashboard" 200
}
